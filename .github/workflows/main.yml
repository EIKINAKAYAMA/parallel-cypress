
name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install modules
        run: |
          npm install
          npm install -g pm2

      - name: Set CI_BUILD_ID
        run: |
          CI_BUILD_ID=$(node scripts/getCiBuildId.js)
          echo "CI_BUILD_ID=$CI_BUILD_ID" >> $GITHUB_ENV

      - name: Build sorry-cypress
        run: |
          docker image build -t sorry-cypress:latest . 
          docker run -d -p 1234:1234 --name sorry-cypress sorry-cypress

      - name: Start react sever
        run: pm2 start 'npm start' --name react-app

  test1:
    name: Test1
    needs:
      - setup
    runs-on: ubuntu-latest
    env:
      CYPRESS_API_URL: 'http://localhost:1234/'
    steps:
      - name: Run cypress stage-1
        run: npx cy2 run --parallel --spec 'cypress/integration/1-parallel-stage-1/1-test1.spec.js' --record --key somekey --ci-build-id $CI_BUILD_ID
  test2:
    name: Test2
    needs: [setup]
    runs-on: ubuntu-latest
    env:
      CYPRESS_API_URL: 'http://localhost:1234/'
    steps:
      - name: Run cypress stage-2
        run: npx cy2 run --parallel --spec 'cypress/integration/2-parallel-stage-2/2-test1.spec.js' --record --key somekey --ci-build-id $CI_BUILD_ID
  
  shutdown:
    name: Shutdown
    needs: [setup, test1, test2]
    runs-on: ubuntu-latest
    steps:
      - name: stop and remove react
        run: |
          pm2 stop react-app
          pm2 delete react-app
          
      - name: stop and remove sorry-cypress
        run: |
          docker stop sorry-cypress
          docker rm sorry-cypress
